version: '3.8'

# ============================================
# Aidos 环境配置
# 使用 SQLite 作为数据库 (开发/小型部署)
# ============================================

services:
  # Aidos API 服务
  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: aidos-api
    restart: ${RESTART_POLICY:-unless-stopped}
    ports:
      - "${API_PORT:-3000}:3000"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - DATABASE_URL=${DATABASE_URL:-./data/aidos.db}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - JWT_SECRET=${JWT_SECRET}
      - ADMIN_PASSWORD_HASH=${ADMIN_PASSWORD_HASH}
      - CORS_ORIGIN=${CORS_ORIGIN:-http://localhost:3000}
      - API_HOST=0.0.0.0
      - API_PORT=3000
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
    networks:
      - aidos-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/health/ready"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    labels:
      - "aidos.version=${AIDOS_VERSION:-latest}"
    # 生产环境资源限制
    deploy:
      resources:
        limits:
          cpus: '${CPU_LIMIT:-1}'
          memory: ${MEMORY_LIMIT:-512M}
        reservations:
          cpus: '0.25'
          memory: 128M

  # 可选: Redis (用于缓存/队列)
  # redis:
  #   image: redis:7-alpine
  #   container_name: aidos-redis
  #   restart: unless-stopped
  #   ports:
  #     - "6379:6379"
  #   volumes:
  #     - redis-data:/data
  #   networks:
  #     - aidos-network

volumes:
  # redis-data:

networks:
  aidos-network:
    driver: bridge

# 环境变量文件
# 复制 .env.example 为 .env 并配置
#
# 启动命令:
# 开发: docker-compose up -d
# 生产: NODE_ENV=production docker-compose -f docker-compose.yml up -d
# 查看日志: docker-compose logs -f
# 停止: docker-compose down
