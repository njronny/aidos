<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AIDOS - AI DevOps System</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="login.css">
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
</head>
<body>
  <!-- Login Page -->
  <div class="login-page hidden" id="loginPage">
    <div class="login-container">
      <div class="login-card">
        <div class="login-header">
          <div class="login-logo">ü§ñ</div>
          <h1 class="login-title">AIDOS</h1>
          <p class="login-subtitle">AI DevOps System - ÁôªÂΩï</p>
        </div>
        <form class="login-form" id="loginForm">
          <div class="form-group">
            <label class="form-label" for="username">Áî®Êà∑Âêç</label>
            <input type="text" class="form-input" id="username" placeholder="ËØ∑ËæìÂÖ•Áî®Êà∑Âêç" autocomplete="username">
          </div>
          <div class="form-group">
            <label class="form-label" for="password">ÂØÜÁ†Å</label>
            <input type="password" class="form-input" id="password" placeholder="ËØ∑ËæìÂÖ•ÂØÜÁ†Å" autocomplete="current-password">
          </div>
          <div class="login-error hidden" id="loginError"></div>
          <button type="submit" class="login-btn" id="loginBtn">ÁôªÂΩï</button>
        </form>
        <div class="login-footer">
          ÈªòËÆ§Ë¥¶Êà∑: admin / aidos123
        </div>
      </div>
    </div>
  </div>

  <!-- Main App Container -->
  <div class="app-container hidden">
    <!-- Header -->
    <header class="header">
      <div class="header-left">
        <h1 class="logo">ü§ñ AIDOS</h1>
        <span class="subtitle">AI DevOps System</span>
      </div>
      <div class="header-right">
        <button class="btn-primary" onclick="showNewRequirementModal()">
          ‚ûï New Requirement
        </button>
        <div class="connection-status" id="connectionStatus">
          <span class="status-dot"></span>
          <span class="status-text">Connecting...</span>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Dashboard Section -->
      <section class="panel dashboard-panel">
        <div class="panel-header">
          <h2>üìä Dashboard</h2>
          <button class="btn-refresh" onclick="Dashboard.refresh()">Refresh</button>
        </div>
        <div class="panel-content">
          <div class="metrics-grid" id="metricsGrid">
            <div class="metric-card">
              <div class="metric-label">Total Projects</div>
              <div class="metric-value" id="totalProjects">-</div>
            </div>
            <div class="metric-card">
              <div class="metric-label">Total Tasks</div>
              <div class="metric-value" id="totalTasks">-</div>
            </div>
            <div class="metric-card">
              <div class="metric-label">Completed</div>
              <div class="metric-value metric-success" id="completedTasks">-</div>
            </div>
            <div class="metric-card">
              <div class="metric-label">Running</div>
              <div class="metric-value metric-running" id="runningTasks">-</div>
            </div>
            <div class="metric-card">
              <div class="metric-label">Failed</div>
              <div class="metric-value metric-failed" id="failedTasks">-</div>
            </div>
            <div class="metric-card">
              <div class="metric-label">Pending</div>
              <div class="metric-value" id="pendingTasks">-</div>
            </div>
            <div class="metric-card metric-wide">
              <div class="metric-label">Progress</div>
              <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
              </div>
              <div class="progress-text" id="progressPercent">0%</div>
            </div>
          </div>
        </div>
      </section>

      <!-- Projects & Requirements Section -->
      <section class="panel projects-panel">
        <div class="panel-header">
          <h2>üìÅ Projects & Requirements</h2>
          <button class="btn-refresh" onclick="loadProjects()">Refresh</button>
        </div>
        <div class="panel-content">
          <div class="projects-list" id="projectsList">
            <div class="empty-state">No projects yet. Click "New Requirement" to start!</div>
          </div>
        </div>
      </section>

      <!-- Flowchart Section -->
      <section class="panel flowchart-panel">
        <div class="panel-header">
          <h2>üîÑ Flowchart</h2>
          <button class="btn-refresh" onclick="Flowchart.refresh()">Refresh</button>
        </div>
        <div class="panel-content">
          <div class="mermaid" id="flowchart"></div>
        </div>
      </section>

      <!-- Task List Section -->
      <section class="panel tasklist-panel">
        <div class="panel-header">
          <h2>üìã Task List</h2>
        </div>
        <div class="panel-content">
          <div class="task-filters">
            <button class="filter-btn active" data-filter="all">All</button>
            <button class="filter-btn" data-filter="pending">Pending</button>
            <button class="filter-btn" data-filter="running">Running</button>
            <button class="filter-btn" data-filter="completed">Completed</button>
            <button class="filter-btn" data-filter="failed">Failed</button>
          </div>
          <div class="task-list" id="taskList">
            <div class="empty-state">No tasks yet</div>
          </div>
        </div>
      </section>

      <!-- Log Section -->
      <section class="panel log-panel">
        <div class="panel-header">
          <h2>üìù Execution Logs</h2>
          <button class="btn-clear" onclick="Log.clear()">Clear</button>
        </div>
        <div class="panel-content">
          <div class="log-container" id="logContainer">
            <div class="log-entry log-info">System initialized</div>
          </div>
        </div>
      </section>
    </main>

    <!-- Footer -->
    <footer class="footer">
      <span>AIDOS v1.0.0</span>
      <span class="separator">|</span>
      <span id="lastUpdate">Last update: --</span>
    </footer>
  </div>

  <!-- New Requirement Modal -->
  <div class="modal" id="newRequirementModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üöÄ New Project / Requirement</h2>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Project Name *</label>
          <input type="text" id="projectName" placeholder="My Awesome Project" required>
        </div>
        <div class="form-group">
          <label>Project Description</label>
          <textarea id="projectDesc" placeholder="Describe your project..."></textarea>
        </div>
        <hr>
        <div class="form-group">
          <label>Requirement Title *</label>
          <input type="text" id="requirementTitle" placeholder="e.g., User Login" required>
        </div>
        <div class="form-group">
          <label>Requirement Description *</label>
          <textarea id="requirementDesc" placeholder="What should be implemented?" required></textarea>
        </div>
        <div class="form-group">
          <label>Priority</label>
          <select id="requirementPriority">
            <option value="low">Low</option>
            <option value="medium" selected>Medium</option>
            <option value="high">High</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn-primary" onclick="submitRequirement()">üöÄ Start Development</button>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="dashboard.js"></script>
  <script src="flowchart.js"></script>
  <script src="tasklist.js"></script>
  <script src="log.js"></script>
  <script src="websocket.js"></script>
  <script src="projects.js"></script>
  <script src="login.js"></script>
  <script>
    // Initialize Mermaid
    mermaid.initialize({
      startOnLoad: false,
      theme: 'dark',
      themeVariables: {
        primaryColor: '#3b82f6',
        primaryTextColor: '#fff',
        primaryBorderColor: '#3b82f6',
        lineColor: '#6b7280',
        secondaryColor: '#1f2937',
        tertiaryColor: '#111827'
      }
    });

    // Modal functions
    function showNewRequirementModal() {
      document.getElementById('newRequirementModal').classList.add('active');
      document.getElementById('projectName').focus();
    }

    function closeModal() {
      document.getElementById('newRequirementModal').classList.remove('active');
    }

    async function submitRequirement() {
      const projectName = document.getElementById('projectName').value.trim();
      const projectDesc = document.getElementById('projectDesc').value.trim();
      const requirementTitle = document.getElementById('requirementTitle').value.trim();
      const requirementDesc = document.getElementById('requirementDesc').value.trim();
      const priority = document.getElementById('requirementPriority').value;

      if (!projectName || !requirementTitle || !requirementDesc) {
        alert('Please fill in required fields!');
        return;
      }

      try {
        // Create project
        const projectRes = await fetch(`${API_URL}/api/projects`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name: projectName, description: projectDesc })
        });
        const projectData = await projectRes.json();

        if (projectData.success) {
          const projectId = projectData.data.id;
          
          // Add requirement
          const reqRes = await fetch(`${API_URL}/api/requirements`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              projectId: projectId,
              title: requirementTitle,
              description: requirementDesc,
              priority: priority
            })
          });
          
          Log.add('info', `Project "${projectName}" created with requirement "${requirementTitle}"`);
          Log.add('success', 'AI agents are now working on your requirement!');
          
          closeModal();
          loadProjects();
          Dashboard.refresh();
          
          // Clear form
          document.getElementById('projectName').value = '';
          document.getElementById('projectDesc').value = '';
          document.getElementById('requirementTitle').value = '';
          document.getElementById('requirementDesc').value = '';
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Failed to create project. Make sure API is running.');
      }
    }

    // API Base URL - ‰ΩøÁî®Ê≠£Á°ÆÁöÑÂä®ÊÄÅËé∑ÂèñÊñπÂºè
    const hostname = window.location.hostname;
    const API_URL = 'http://' + hostname + ':3000';
    // ‰øùÂ≠òÂà∞ÂÖ®Â±ÄÂèòÈáè‰æõÂÖ∂‰ªñJS‰ΩøÁî®
    var API_URL_FOR_ALL = API_URL;

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      Log.add('info', 'AIDOS UI initialized');
      WebSocket.connect();
      Dashboard.refresh();
      loadProjects();
      TaskList.refresh();
    });

    // Close modal on outside click
    document.getElementById('newRequirementModal').addEventListener('click', (e) => {
      if (e.target.classList.contains('modal')) {
        closeModal();
      }
    });
  </script>
</body>
</html>
